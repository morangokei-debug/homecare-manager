# 要件定義書：Homecare Manager

> **バージョン**: 1.3.0  
> **作成日**: 2024-12-24  
> **更新日**: 2024-12-24  
> **ステータス**: 確定（全質問回答完了）

---

## 目次

1. [目的・背景](#1-目的背景)
2. [対象ユーザー](#2-対象ユーザー)
3. [用語定義](#3-用語定義)
4. [ユースケース一覧](#4-ユースケース一覧)
5. [画面一覧](#5-画面一覧)
6. [機能要件](#6-機能要件)
7. [データ項目一覧](#7-データ項目一覧)
8. [主要な業務フロー](#8-主要な業務フロー)
9. [非機能要件](#9-非機能要件)
10. [未決事項・質問リスト](#10-未決事項質問リスト)
11. [MVP範囲提案](#11-mvp範囲提案)
12. [次ステップ：設計書の提案](#12-次ステップ設計書の提案)

---

## 1. 目的・背景

### 1.1 背景

在宅訪問薬剤師業務において、以下の課題が存在する：

- 訪問スケジュールと処方管理が別々に管理され、情報が分散している
- 個人宅と施設で対象者の管理方法が異なり、一覧性が低い
- 対応患者数の増加に伴い、必要な情報へのアクセスに時間がかかる
- 店舗内で予定を確認する際、毎回アプリを操作する必要がある
- 複数スタッフ・複数端末での情報共有が困難

### 1.2 目的

本システム「Homecare Manager」は以下を実現する：

1. **一元管理**: 訪問業務と処方管理を単一システムで管理
2. **カレンダー中心運用**: 訪問カレンダーを主軸とした直感的なUI
3. **対象者の分類表示**: 個人宅・施設を明確に区分した一覧表示
4. **高速な情報アクセス**: 検索機能による素早い情報到達
5. **オフライン共有**: 確定予定のPDF出力による店舗内共有
6. **チーム運用**: ログイン機能による複数スタッフ・端末対応

---

## 2. 対象ユーザー

| ロール | 説明 | 主な利用シーン |
|--------|------|----------------|
| **Admin（管理者）** | システム全体を管理するスタッフ | ユーザー管理、設定変更、全データ管理 |
| **Staff（一般）** | 日常業務を行う薬剤師・スタッフ | 予定登録・編集、リマインド確認、PDF出力 |
| **Viewer（閲覧者）** | 閲覧のみ行うスタッフ | 店舗共有PCでの予定確認、PDF出力 |

### 利用環境

- **デバイス**: PC（Chrome推奨）、タブレット、スマートフォン
- **共有PC**: 店舗内共有PCではViewer権限での閲覧運用を想定

---

## 3. 用語定義

| 用語 | 定義 |
|------|------|
| **患者マスタ** | 個人宅の在宅患者を管理するマスタデータ |
| **施設マスタ** | 介護施設等を管理するマスタデータ |
| **訪問イベント** | 患者宅または施設への訪問予定 |
| **処方イベント** | 処方箋の発行予定日を管理するイベント |
| **個人宅** | 在宅患者の自宅（患者マスタで facility_id = NULL） |
| **施設** | 介護施設等（施設マスタで管理、患者が所属） |
| **施設入所患者** | 施設に所属する患者（患者マスタで facility_id あり） |
| **担当者** | イベントに割り当てられたスタッフ（作成者とは別に設定可能） |
| **下書き** | 未確定の予定。変更可能な状態 |
| **確定** | 確定済みの予定。PDF出力の対象 |
| **リマインド** | 予定の事前通知機能（作成者へメール通知） |
| **対象区分** | 個人宅／施設の分類 |
| **定期処方** | 定期的に発生する処方。間隔を記録し「次回作成」を補助 |

---

## 4. ユースケース一覧

### 4.1 認証・ユーザー管理

| ID | ユースケース名 | アクター | 概要 |
|----|---------------|---------|------|
| UC-001 | ログイン | 全ユーザー | メール＋パスワードでシステムにログイン |
| UC-002 | ログアウト | 全ユーザー | セッションを終了しログアウト |
| UC-003 | ユーザー登録 | Admin | 新規ユーザーを登録しロールを付与 |
| UC-004 | ユーザー編集 | Admin | 既存ユーザーの情報・ロールを変更 |
| UC-005 | ユーザー削除 | Admin | ユーザーを無効化（論理削除） |
| UC-006 | パスワード変更 | 全ユーザー | 自身のパスワードを変更 |

### 4.2 マスタ管理

| ID | ユースケース名 | アクター | 概要 |
|----|---------------|---------|------|
| UC-051 | 患者登録 | Admin, Staff | 新規患者をマスタに登録 |
| UC-052 | 患者編集 | Admin, Staff | 患者情報を編集 |
| UC-053 | 患者削除 | Admin | 患者を無効化（論理削除） |
| UC-054 | 患者一覧・検索 | 全ユーザー | 患者をリスト表示・検索 |
| UC-055 | 施設登録 | Admin, Staff | 新規施設をマスタに登録 |
| UC-056 | 施設編集 | Admin, Staff | 施設情報を編集 |
| UC-057 | 施設削除 | Admin | 施設を無効化（論理削除） |
| UC-058 | 施設一覧・検索 | 全ユーザー | 施設をリスト表示・検索 |

### 4.3 予定管理

| ID | ユースケース名 | アクター | 概要 |
|----|---------------|---------|------|
| UC-101 | 訪問イベント登録 | Admin, Staff | マスタから対象を選択し訪問予定を登録 |
| UC-102 | 訪問イベント編集 | Admin, Staff | 既存訪問予定を編集 |
| UC-103 | 訪問イベント削除 | Admin, Staff | 訪問予定を削除 |
| UC-104 | 処方イベント登録 | Admin, Staff | 処方予定を登録（マスタから対象選択） |
| UC-105 | 処方イベント編集 | Admin, Staff | 処方予定を編集 |
| UC-106 | 処方イベント削除 | Admin, Staff | 処方予定を削除 |
| UC-107 | 次回処方作成 | Admin, Staff | 定期処方の「次回作成」ボタンで次回分を自動入力 |
| UC-108 | イベント完了 | Admin, Staff | イベントを完了状態にする |
| UC-109 | カレンダー表示 | 全ユーザー | 月・週・日単位で予定をカレンダー表示 |
| UC-110 | リスト表示・検索 | 全ユーザー | 予定をリスト形式で表示し検索 |
| UC-111 | 対象区分フィルタ | 全ユーザー | 個人宅・施設で絞り込み表示 |

### 4.4 リマインド

| ID | ユースケース名 | アクター | 概要 |
|----|---------------|---------|------|
| UC-201 | リマインド設定 | Admin, Staff | 訪問・処方それぞれのリマインドON/OFF設定 |
| UC-202 | リマインドタイミング選択 | Admin, Staff | プリセットから通知タイミングを複数選択 |
| UC-203 | リマインド確認 | 全ユーザー | アプリ内でリマインド通知を確認 |

### 4.5 確定・PDF出力

| ID | ユースケース名 | アクター | 概要 |
|----|---------------|---------|------|
| UC-301 | 予定確定 | Admin, Staff | 下書き予定を確定状態に変更 |
| UC-302 | 確定取消 | Admin, Staff | 確定を取り消し下書きに戻す |
| UC-303 | 日次PDF出力 | 全ユーザー | 指定日の予定をPDF出力 |
| UC-304 | 週次PDF出力 | 全ユーザー | 指定週の予定をPDF出力 |
| UC-305 | PDF出力フィルタ設定 | 全ユーザー | 出力対象を絞り込み（区分・完了状態） |

---

## 5. 画面一覧

### 5.1 画面構成図

```
[ログイン画面]
    │
    ▼
[メイン画面（カレンダー）] ─── [リスト表示画面]
    │                              │
    ├── [イベント詳細/編集]         ├── [検索結果]
    │                              │
    ├── [リマインド一覧] ◄──────────┘
    │
    ├── [PDF出力画面]
    │
    ├── [患者管理画面]
    │       ├── [患者一覧]
    │       └── [患者登録/編集]
    │
    ├── [施設管理画面]
    │       ├── [施設一覧]
    │       └── [施設登録/編集]
    │
    └── [設定画面]
            │
            ├── [ユーザー管理] ※Admin専用
            ├── [リマインド設定]
            └── [アカウント設定]
```

### 5.2 画面詳細

| 画面ID | 画面名 | 役割 | 主要UI要素 |
|--------|--------|------|-----------|
| SCR-001 | ログイン | 認証 | メール入力、パスワード入力、ログインボタン |
| SCR-002 | カレンダー（メイン） | 予定の俯瞰表示 | 月/週/日切替、イベントカード、新規作成FAB、区分フィルタ |
| SCR-003 | リスト表示 | 予定の一覧・検索 | 検索バー、フィルタ、ソート、イベント行 |
| SCR-004 | イベント詳細 | イベント閲覧 | 全項目表示、編集ボタン、削除ボタン、完了ボタン |
| SCR-005 | イベント編集 | イベント作成・編集 | フォーム（種別、日時、対象、場所、メモ等） |
| SCR-006 | リマインド一覧 | 通知確認 | 未読/既読リマインド一覧、対象イベントへのリンク |
| SCR-007 | PDF出力 | 予定表出力 | 期間選択、フィルタ設定、プレビュー、出力ボタン |
| SCR-008 | 設定トップ | 設定メニュー | 各設定へのナビゲーション |
| SCR-009 | ユーザー管理 | ユーザーCRUD | ユーザー一覧、追加、編集、削除 |
| SCR-010 | リマインド設定 | 通知設定 | 訪問/処方のON/OFF、タイミング選択 |
| SCR-011 | アカウント設定 | 個人設定 | パスワード変更、表示名変更 |
| SCR-012 | 患者一覧 | 患者マスタ閲覧 | 検索バー、患者リスト、新規追加ボタン |
| SCR-013 | 患者登録/編集 | 患者マスタCRUD | 患者情報フォーム |
| SCR-014 | 施設一覧 | 施設マスタ閲覧 | 検索バー、施設リスト、新規追加ボタン |
| SCR-015 | 施設登録/編集 | 施設マスタCRUD | 施設情報フォーム |

### 5.3 画面アクセス権限

| 画面 | Admin | Staff | Viewer |
|------|:-----:|:-----:|:------:|
| ログイン | ○ | ○ | ○ |
| カレンダー | ○ | ○ | ○ |
| リスト表示 | ○ | ○ | ○ |
| イベント詳細 | ○ | ○ | ○ |
| イベント編集 | ○ | ○ | × |
| リマインド一覧 | ○ | ○ | ○ |
| PDF出力 | ○ | ○ | ○ |
| ユーザー管理 | ○ | × | × |
| リマインド設定 | ○ | ○ | × |
| アカウント設定 | ○ | ○ | ○ |
| 患者一覧 | ○ | ○ | ○ |
| 患者登録/編集 | ○ | ○ | × |
| 施設一覧 | ○ | ○ | ○ |
| 施設登録/編集 | ○ | ○ | × |

---

## 6. 機能要件

### 6.1 認証・認可

#### FR-001: ログイン

| 項目 | 内容 |
|------|------|
| 概要 | メールアドレスとパスワードによる認証 |
| 入力 | メールアドレス、パスワード |
| 処理 | 認証成功時はセッショントークンを発行しメイン画面へ遷移 |
| エラー | 認証失敗時はエラーメッセージを表示（詳細は漏らさない） |

#### FR-002: ログアウト

| 項目 | 内容 |
|------|------|
| 概要 | セッションを破棄しログイン画面へ遷移 |
| 処理 | サーバー側でセッション/トークンを無効化 |

#### FR-003: 認可（権限チェック）

| 項目 | 内容 |
|------|------|
| 概要 | 各操作・画面アクセス時にロールベースで権限チェック |
| 実装箇所 | 画面（フロント）およびAPI（バックエンド）の両方 |
| 権限不足時 | 403エラーまたは該当UIを非表示 |

#### FR-004: パスワード管理

| 項目 | 内容 |
|------|------|
| ハッシュ化 | bcrypt等でソルト付きハッシュ化して保存 |
| 最小要件 | 8文字以上（英数字混在推奨） |

#### FR-005: ユーザー管理（Admin専用）

| 項目 | 内容 |
|------|------|
| 登録 | メール、表示名、初期パスワード、ロールを設定 |
| 編集 | 表示名、ロールの変更 |
| 削除 | 論理削除（is_activeフラグ） |
| パスワードリセット | 管理者が任意のユーザーのパスワードを再設定可能 |

#### FR-006: 担当者機能

| 項目 | 内容 |
|------|------|
| 概要 | イベントに担当スタッフを割り当てる |
| 設定 | イベント作成/編集時に担当者を選択（任意） |
| 未割当 | 担当者なしでの登録も可能 |
| フィルタ | カレンダー/リストで担当者フィルタ可能 |

---

### 6.2 予定（イベント）管理

#### FR-101: 訪問イベント

**データ項目**

| 項目名 | 必須 | 型 | 説明 |
|--------|:----:|-----|------|
| 日付 | ○ | Date | 訪問予定日 |
| 時刻 | - | Time | 訪問予定時刻（未入力可） |
| 対象区分 | ○ | Enum | 個人宅 / 施設 |
| 患者名/施設名 | ○ | String | 訪問先名称 |
| 場所 | - | String | 住所または簡易エリア |
| メモ | - | Text | 自由記述 |
| ステータス | ○ | Enum | 下書き / 確定 |
| 完了フラグ | ○ | Boolean | 完了済みかどうか |

#### FR-102: 処方イベント

**データ項目**

| 項目名 | 必須 | 型 | 説明 |
|--------|:----:|-----|------|
| 発行予定日 | ○ | Date | 処方箋発行予定日 |
| 対象区分 | ○ | Enum | 個人宅 / 施設 |
| 患者/施設 | ○ | FK | マスタから選択（患者ID or 施設ID） |
| 定期フラグ | ○ | Boolean | 定期処方かどうか |
| 定期間隔 | - | Integer | 定期の場合の間隔（日数）※ユーザーが任意入力 |
| メモ | - | Text | 自由記述 |
| ステータス | ○ | Enum | 下書き / 確定 |
| 完了フラグ | ○ | Boolean | 完了済みかどうか |

#### FR-103: 定期処方の「次回作成」機能

| 項目 | 内容 |
|------|------|
| 概要 | 定期処方イベントから「次回作成」ボタンで次回分を簡単に作成 |
| 動作 | 現在の発行予定日 ＋ 定期間隔（日数）を初期値として新規イベント作成画面を開く |
| 間隔未入力時 | 「次回作成」ボタンは非表示（手動で新規作成） |
| 自動生成 | なし（都度ユーザーが「次回作成」を実行） |

#### FR-104: カレンダー表示

| 項目 | 内容 |
|------|------|
| 表示単位 | 月表示 / 週表示 / 日表示 |
| 初期表示 | **週表示**をデフォルト |
| イベント表示形式 | `[アイコン] 患者名 or 施設名`（省スペース） |
| アイコン | 訪問：🏠（個人宅）/🏢（施設）、処方：💊 |
| フィルタ | 対象区分（個人宅/施設/両方）、担当者 |

**表示ルール:**
- 個人宅患者 → 「🏠 患者名」
- 施設入所患者（display_mode = grouped）→ 同日同施設をまとめて「🏢 施設名」
- 施設入所患者（display_mode = individual）→ 「🏢 患者名」で個別表示

#### FR-105: リスト表示・検索

| 項目 | 内容 |
|------|------|
| 検索対象 | 患者名/施設名、場所、メモ |
| フィルタ | 対象区分、イベント種別、ステータス、完了状態、期間 |
| ソート | 日付昇順/降順、名前順 |

---

### 6.3 リマインド

#### FR-201: リマインド設定

| 項目 | 内容 |
|------|------|
| 種別ごと設定 | 訪問リマインド、処方リマインドを個別にON/OFF |
| タイミング | プリセットから複数選択 |

**訪問リマインド タイミング**

| プリセット | 発火条件 |
|-----------|---------|
| 前日 18:00 | 訪問日の前日 18:00 |
| 当日 9:00 | 訪問日の当日 9:00 |
| 1時間前 | 訪問時刻の1時間前（時刻未入力時は発火しない） |
| 30分前 | 訪問時刻の30分前（時刻未入力時は発火しない） |

**処方リマインド タイミング**

| プリセット | 発火条件 |
|-----------|---------|
| 前日 18:00 | 発行予定日の前日 18:00 |
| 当日 9:00 | 発行予定日の当日 9:00 |

#### FR-202: リマインド統合

| 項目 | 内容 |
|------|------|
| 同時発火時 | 訪問・処方が同タイミングの場合、1メッセージに統合 |
| 時刻未入力時 | 1時間前/30分前は発火せず、当日9:00にまとめる |

#### FR-203: リマインド表示

| 項目 | 内容 |
|------|------|
| 表示場所 | アプリ内リマインド一覧画面 |
| 通知バッジ | 未読リマインドがある場合、ヘッダーにバッジ表示 |
| 状態管理 | 未読 / 既読 |

#### FR-204: メール通知（※MVP後または技術検証後）

| 項目 | 内容 |
|------|------|
| 通知対象 | イベント作成者のみ（作成者のログインメールアドレス宛） |
| 通知タイミング | リマインド設定に準拠 |
| 実装優先度 | 技術的に難しい場合は保留可（アプリ内リマインドを優先） |
| 送信元 | 要検討（システムメールアドレス） |

---

### 6.4 確定・PDF出力

#### FR-301: 予定の確定

| 項目 | 内容 |
|------|------|
| ステータス遷移 | 下書き → 確定 |
| 確定取消 | 確定 → 下書き（Admin, Staffのみ） |
| 一括確定 | 日付範囲を指定して一括で確定 |

#### FR-302: PDF出力

**出力形式**

| 項目 | 内容 |
|------|------|
| 用紙 | A4縦 |
| 出力単位 | 日次 / 週次（月〜日） |
| 対象データ | 原則「確定」のみ。下書き出力時はウォーターマーク付与 |

**レイアウト**

```
┌─────────────────────────────────────────────────────────────┐
│  予定表：2024年12月24日（火）                                │
│  出力日時：2024-12-24 10:00                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  09:00  🏠  山田太郎      品川区東五反田    バイタル確認     │
│  10:30  🏠  佐藤花子      港区芝浦          服薬指導         │
│  14:00  💊  田中一郎      渋谷区恵比寿      定期処方         │
│  15:00  🏠  ケアホーム東京  江東区豊洲       施設訪問         │
│   --    💊  鈴木次郎      目黒区中目黒      処方確認         │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  ※ 時刻「--」は時刻未設定                                   │
│  ※ 🏠=訪問  💊=処方                                         │
└─────────────────────────────────────────────────────────────┘
```

**フィルタ設定**

| フィルタ | 選択肢 |
|---------|--------|
| 対象区分 | 個人宅のみ / 施設のみ / 両方 |
| 完了状態 | 完了済み含む / 完了済み除外 |

**ファイル命名規則**

| 出力単位 | ファイル名 |
|---------|-----------|
| 日次 | `schedule_YYYY-MM-DD.pdf` |
| 週次 | `schedule_YYYY-MM-DD_to_YYYY-MM-DD.pdf` |

---

## 7. データ項目一覧

### 7.1 エンティティ関連図

```
┌─────────────┐       ┌─────────────────┐
│    User     │       │  ReminderSetting │
│─────────────│       │─────────────────│
│ id          │◄──────│ user_id         │
│ email       │       │ visit_enabled   │
│ password    │       │ rx_enabled      │
│ name        │       │ visit_timings   │
│ role        │       │ rx_timings      │
│ is_active   │       └─────────────────┘
│ created_at  │
│ updated_at  │       ┌─────────────────┐
└─────────────┘       │    Reminder     │
       │              │─────────────────│
       │ created_by   │ id              │
       │ assigned_to  │ user_id         │
       ▼              │ event_id        │
┌─────────────┐◄──────│ scheduled_at    │
│   Event     │       │ is_read         │
│─────────────│       │ message         │
│ id          │       └─────────────────┘
│ type        │
│ date        │
│ time        │
│ patient_id  │────────────┐
│ assigned_to │            │
│ memo        │            │
│ status      │            │
│ is_completed│            │
│ is_recurring│            │
│ interval    │            │
│ created_by  │            │
│ created_at  │            │
│ updated_at  │            │
└─────────────┘            │
                           │
                           ▼
┌─────────────┐       ┌─────────────┐
│  Facility   │◄──────│   Patient   │
│─────────────│       │─────────────│
│ id          │       │ id          │
│ name        │       │ name        │
│ address     │       │ facility_id │───┐ NULL = 個人宅
│ area        │       │ address     │   │ 値あり = 施設入所
│ phone       │       │ area        │   │
│ contact     │       │ phone       │   │
│ display_mode│       │ memo        │   │
│ memo        │       │ is_active   │   │
│ is_active   │       │ created_at  │   │
│ created_at  │       │ updated_at  │   │
│ updated_at  │       └─────────────┘   │
└─────────────┘◄────────────────────────┘
```

**表示ロジック:**
- 患者の `facility_id = NULL` → 「🏠 患者名」で表示
- 患者の `facility_id` あり かつ 施設の `display_mode = grouped` → 「🏢 施設名」でまとめ表示
- 患者の `facility_id` あり かつ 施設の `display_mode = individual` → 「🏢 患者名」で個別表示

### 7.2 User（ユーザー）

| カラム名 | 型 | 必須 | 説明 |
|---------|-----|:----:|------|
| id | UUID | ○ | 主キー |
| email | String | ○ | メールアドレス（ユニーク） |
| password_hash | String | ○ | ハッシュ化パスワード |
| name | String | ○ | 表示名 |
| role | Enum | ○ | admin / staff / viewer |
| is_active | Boolean | ○ | 有効フラグ（デフォルト: true） |
| created_at | Timestamp | ○ | 作成日時 |
| updated_at | Timestamp | ○ | 更新日時 |

### 7.3 Patient（患者マスタ）

| カラム名 | 型 | 必須 | 説明 |
|---------|-----|:----:|------|
| id | UUID | ○ | 主キー |
| name | String | ○ | 患者氏名 |
| name_kana | String | - | 患者氏名（カナ）※検索用 |
| facility_id | UUID | - | 所属施設ID（NULL = 個人宅、値あり = 施設入所） |
| address | String | - | 住所（個人宅の場合は自宅住所） |
| area | String | - | 簡易エリア（例：品川区東五反田） |
| phone | String | - | 電話番号 |
| memo | Text | - | メモ（特記事項等） |
| is_active | Boolean | ○ | 有効フラグ（デフォルト: true） |
| created_at | Timestamp | ○ | 作成日時 |
| updated_at | Timestamp | ○ | 更新日時 |

**facility_id について:**
- `NULL`: 個人宅（在宅療養）の患者
- `値あり`: 施設入所の患者（該当施設のIDを参照）

### 7.4 Facility（施設マスタ）

| カラム名 | 型 | 必須 | 説明 |
|---------|-----|:----:|------|
| id | UUID | ○ | 主キー |
| name | String | ○ | 施設名 |
| name_kana | String | - | 施設名（カナ）※検索用 |
| address | String | - | 住所 |
| area | String | - | 簡易エリア |
| phone | String | - | 電話番号 |
| contact_person | String | - | 担当者名 |
| display_mode | Enum | ○ | grouped（施設名でまとめ表示） / individual（患者個別表示） |
| memo | Text | - | メモ |
| is_active | Boolean | ○ | 有効フラグ（デフォルト: true） |
| created_at | Timestamp | ○ | 作成日時 |
| updated_at | Timestamp | ○ | 更新日時 |

**display_mode について:**
- `grouped`: カレンダー/リストで「🏢 施設名」としてまとめて表示（複数患者がいる場合に有効）
- `individual`: カレンダー/リストで患者ごとに個別表示（施設に1名のみの場合など）

### 7.5 Event（イベント）

| カラム名 | 型 | 必須 | 説明 |
|---------|-----|:----:|------|
| id | UUID | ○ | 主キー |
| type | Enum | ○ | visit（訪問） / prescription（処方） |
| date | Date | ○ | 予定日 |
| time | Time | - | 予定時刻（訪問のみ、NULL許容） |
| patient_id | UUID | ○ | 患者ID（患者マスタから選択） |
| assigned_to | UUID | - | 担当者ユーザーID（NULLの場合は未割当） |
| memo | Text | - | イベント固有のメモ |
| status | Enum | ○ | draft（下書き） / confirmed（確定） |
| is_completed | Boolean | ○ | 完了フラグ（デフォルト: false） |
| is_recurring | Boolean | ○ | 定期フラグ（処方のみ使用） |
| recurring_interval | Integer | - | 定期間隔（日数、ユーザー任意入力） |
| created_by | UUID | ○ | 作成者ユーザーID（外部キー）※リマインド通知先 |
| created_at | Timestamp | ○ | 作成日時 |
| updated_at | Timestamp | ○ | 更新日時 |

**個人宅/施設の判定:**
- イベントは「患者」を選択するだけ
- 患者の `facility_id` が NULL → 個人宅
- 患者の `facility_id` が値あり → 施設入所
- 表示時は施設の `display_mode` 設定に従う

### 7.6 ReminderSetting（リマインド設定）

| カラム名 | 型 | 必須 | 説明 |
|---------|-----|:----:|------|
| id | UUID | ○ | 主キー |
| user_id | UUID | ○ | ユーザーID（外部キー） |
| visit_enabled | Boolean | ○ | 訪問リマインドON/OFF |
| visit_timings | JSON | - | 選択されたタイミング配列 |
| rx_enabled | Boolean | ○ | 処方リマインドON/OFF |
| rx_timings | JSON | - | 選択されたタイミング配列 |
| created_at | Timestamp | ○ | 作成日時 |
| updated_at | Timestamp | ○ | 更新日時 |

### 7.7 Reminder（リマインド通知）

| カラム名 | 型 | 必須 | 説明 |
|---------|-----|:----:|------|
| id | UUID | ○ | 主キー |
| user_id | UUID | ○ | 通知先ユーザーID |
| event_id | UUID | ○ | 対象イベントID |
| scheduled_at | Timestamp | ○ | 通知予定日時 |
| is_read | Boolean | ○ | 既読フラグ |
| message | Text | ○ | 通知メッセージ |
| created_at | Timestamp | ○ | 作成日時 |

---

## 8. 主要な業務フロー

### 8.1 日常運用フロー

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   ログイン   │───▶│  予定確認    │───▶│  予定登録    │───▶│   保存      │
└─────────────┘    │（カレンダー）│    │  ・編集     │    │（下書き）   │
                   └─────────────┘    └─────────────┘    └─────────────┘
                          │                                      │
                          ▼                                      ▼
                   ┌─────────────┐                        ┌─────────────┐
                   │ リマインド   │                        │   確定      │
                   │  確認       │                        └─────────────┘
                   └─────────────┘                               │
                                                                 ▼
                                                          ┌─────────────┐
                                                          │  PDF出力    │
                                                          └─────────────┘
                                                                 │
                                                                 ▼
                                                          ┌─────────────┐
                                                          │  印刷・共有  │
                                                          └─────────────┘
```

### 8.2 週次PDF出力フロー

```
1. Staff/Admin がログイン
2. カレンダー画面で翌週の予定を確認
3. 未確定の予定があれば確定処理
4. PDF出力画面へ遷移
5. 期間（翌週月〜日）を選択
6. フィルタ設定（必要に応じて）
7. プレビュー確認
8. PDF出力・ダウンロード
9. 店舗で印刷・掲示
```

### 8.3 定期処方の運用フロー

```
【初回登録】
1. イベント編集画面で「処方」を選択
2. マスタから患者/施設を選択
3. 「定期」にチェック
4. 間隔（例：28日）を任意入力
5. 初回発行予定日を入力
6. 保存

【次回作成】
1. 処方イベント詳細画面を開く
2. 「次回作成」ボタンをクリック
3. 次回の発行予定日が自動計算された状態で新規作成画面が開く
   （現在の日付 + 定期間隔）
4. 必要に応じて日付を調整
5. 保存
```

---

## 9. 非機能要件

### 9.1 セキュリティ

| 項目 | 要件 |
|------|------|
| 認証 | セッションまたはJWTトークンによる認証状態管理 |
| パスワード | bcrypt等でソルト付きハッシュ化（平文保存禁止） |
| 通信 | HTTPS必須 |
| 権限チェック | 画面（フロント）およびAPI（バックエンド）の両方で実施 |
| セッション有効期限 | 24時間（設定可能） |
| CSRF対策 | トークンベースのCSRF対策を実装 |

### 9.2 監査・ログ

| 項目 | 要件 |
|------|------|
| 認証ログ | ログイン成功/失敗、ログアウトを記録 |
| 操作ログ | イベントの作成・編集・削除・確定を記録 |
| 保持期間 | 最低1年間 |

### 9.3 パフォーマンス

| 項目 | 要件 |
|------|------|
| 画面表示 | 3秒以内（初期ロード） |
| 検索応答 | 1秒以内 |
| PDF生成 | 5秒以内（週次） |
| 同時接続 | 10ユーザー程度を想定 |

### 9.4 可用性

| 項目 | 要件 |
|------|------|
| 稼働時間 | 平日 8:00〜20:00（業務時間内） |
| バックアップ | 日次バックアップ |
| データ復旧 | 24時間以内 |

### 9.5 対応環境

| 項目 | 要件 |
|------|------|
| ブラウザ | Chrome最新版（推奨）、Safari、Edge |
| デバイス | PC、タブレット、スマートフォン（レスポンシブ対応） |
| 画面解像度 | 最小 375px（モバイル）〜 1920px（デスクトップ） |

---

## 10. 未決事項・質問リスト

### 10.1 解決済みの質問

| No. | 質問 | 回答 |
|-----|------|------|
| Q1 | 患者/施設のマスタ管理は必要か？ | ✅ **必要**。マスタから選択する方式 |
| Q2 | 定期処方の自動生成範囲は？ | ✅ **自動生成なし**。都度入力が基本、間隔を入力して「次回作成」補助 |
| Q3 | リマインド通知の対象ユーザーは？ | ✅ **作成者のみ**。メール通知（技術的に難しければ保留可） |
| Q4 | 患者マスタに必要な項目は？ | ✅ **最小限でスタート**（氏名、カナ、住所、エリア、電話、メモ、所属施設） |
| Q5 | 施設マスタに必要な項目は？ | ✅ **最小限でスタート**（施設名、カナ、住所、エリア、電話、担当者、メモ、表示モード） |
| Q6 | 施設内の患者管理は？ | ✅ **患者個別管理**。患者ごとに施設or個人宅を設定。施設には表示モード設定あり |
| Q11 | カレンダーの初期表示は？ | ✅ **週表示** |
| Q12 | 「担当者」の概念は必要か？ | ✅ **必要**。イベントに担当スタッフを割り当て可能 |
| Q13 | パスワードリセット機能は？ | ✅ **初期リリースで必要**。管理者権限で他ユーザーのパスワードをリセット可能 |
| Q7 | 患者/施設を削除した場合、関連イベントは？ | ✅ **論理削除＋表示名保持**（過去イベントは残り、削除時点の名前で表示） |
| Q8 | 同じ日時に複数イベントは許容？ | ✅ **許容**（重複チェックなし） |
| Q9 | 完了フラグは手動のみ？ | ✅ **手動のみ**（自動完了なし） |
| Q10 | 過去データの保持期間は？ | ✅ **全期間表示**（フィルタで絞り込み可能） |

### 10.2 未決事項

現時点で未決事項はありません。開発中に発生した課題はここに追記します。

---

## 11. MVP範囲提案

### 11.1 MVP（Minimum Viable Product）に含める機能

| カテゴリ | 機能 | MVP |
|---------|------|:---:|
| **認証** | ログイン/ログアウト | ○ |
| | ユーザー管理（Admin） | ○ |
| | パスワード変更 | ○ |
| | パスワードリセット（Admin権限） | ○ |
| **マスタ管理** | 患者マスタCRUD（施設/個人宅設定含む） | ○ |
| | 施設マスタCRUD（表示モード設定含む） | ○ |
| | マスタ検索 | ○ |
| **予定管理** | 訪問イベントCRUD | ○ |
| | 処方イベントCRUD | ○ |
| | 定期処方（間隔入力＋次回作成） | ○ |
| | 担当者割り当て | ○ |
| | カレンダー表示（月/週/日、初期：週） | ○ |
| | リスト表示・検索 | ○ |
| | 対象区分フィルタ | ○ |
| | 担当者フィルタ | ○ |
| | 確定/下書きステータス | ○ |
| | 完了フラグ | ○ |
| **リマインド** | アプリ内リマインド | ○ |
| | リマインド設定 | ○ |
| | メール通知 | △（技術検証後） |
| | OS通知（Push） | ×（将来） |
| **PDF出力** | 日次PDF | ○ |
| | 週次PDF | ○ |
| | フィルタ設定 | ○ |

### 11.2 リリースフェーズ案

```
【Phase 1: MVP】約6〜8週間
├─ 認証基盤（ログイン、ユーザー管理、パスワードリセット）
├─ 患者マスタ（施設/個人宅の設定含む）
├─ 施設マスタ（表示モード設定含む）
├─ 予定管理（訪問・処方CRUD、定期処方の次回作成）
├─ 担当者機能（割り当て、フィルタ）
├─ カレンダー表示（月/週/日、週表示デフォルト）
├─ リスト表示・検索
├─ 確定・PDF出力（日次/週次）
└─ アプリ内リマインド

【Phase 2: 拡張】約2〜3週間
├─ メール通知（技術検証後）
├─ リマインド統合ロジック
└─ 操作ログ・監査機能

【Phase 3: 改善】約2週間
├─ パフォーマンス最適化
└─ UI/UX改善

【将来】
├─ OS通知（Push通知）
├─ オフライン対応
└─ 多店舗対応
```

---

## 12. 次ステップ：設計書の提案

要件定義完了後、以下の設計書を順次作成することを推奨します。

### 12.1 作成すべき設計書

| 順序 | 設計書 | 目的 | 成果物 |
|:----:|--------|------|--------|
| 1 | **画面設計書** | UIの詳細仕様を定義 | ワイヤーフレーム、画面遷移図、UI仕様 |
| 2 | **データ設計書** | DB構造を定義 | ER図、テーブル定義書、インデックス設計 |
| 3 | **API設計書** | バックエンドI/Fを定義 | エンドポイント一覧、リクエスト/レスポンス仕様 |
| 4 | **タスク分割・見積もり** | 開発計画を策定 | タスク一覧、工数見積もり、スケジュール |

### 12.2 推奨する進め方

```
1. 【質問リスト回答】Q1〜Q3の回答を確定
      ↓
2. 【画面設計】主要画面のワイヤーフレーム作成
      ↓
3. 【データ設計】ER図・テーブル定義
      ↓
4. 【API設計】エンドポイント定義
      ↓
5. 【技術選定】フレームワーク、ライブラリ選定
      ↓
6. 【タスク分割】開発タスクの洗い出しと見積もり
      ↓
7. 【開発着手】Phase 1 MVP開発開始
```

---

## 改訂履歴

| バージョン | 日付 | 変更内容 | 担当 |
|-----------|------|---------|------|
| 1.0.0 | 2024-12-24 | 初版作成 | - |
| 1.1.0 | 2024-12-24 | Q1〜Q3回答反映：患者/施設マスタ追加、定期処方を次回作成方式に変更、リマインド通知対象を作成者に限定 | - |
| 1.2.0 | 2024-12-24 | Q4〜Q6, Q11〜Q13回答反映：患者に施設所属設定追加、施設に表示モード追加、担当者機能追加、パスワードリセット（Admin）を初期リリースに含める | - |
| 1.3.0 | 2024-12-24 | Q7〜Q10回答反映（提案値で確定）。要件定義完了 | - |

---

*以上*

