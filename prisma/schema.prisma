// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  admin
  staff
  viewer
}

enum DisplayMode {
  grouped
  individual
}

enum EventType {
  visit
  prescription
}

enum EventStatus {
  draft
  confirmed
}

// ============================================
// MODELS
// ============================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  name          String
  role          UserRole @default(staff)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  reminderSetting  ReminderSetting?
  createdEvents    Event[]    @relation("EventCreatedBy")
  assignedEvents   Event[]    @relation("EventAssignedTo")
  reminders        Reminder[]
  
  // 患者サマリー関連
  summariesAsRecentChangesUpdater PatientSummary[] @relation("SummaryRecentChangesUpdater")
  summariesAsCreator              PatientSummary[] @relation("SummaryCreator")
  summariesAsUpdater              PatientSummary[] @relation("SummaryUpdater")
  summaryHistories                PatientSummaryHistory[]
  
  // 患者ドキュメント関連
  uploadedDocuments PatientDocument[]

  @@index([role])
  @@index([isActive])
  @@map("users")
}

model Facility {
  id            String      @id @default(uuid())
  name          String
  nameKana      String?     @map("name_kana")
  address       String?
  area          String?
  phone         String?
  contactPerson String?     @map("contact_person")
  displayMode   DisplayMode @default(grouped) @map("display_mode")
  memo          String?
  isActive      Boolean     @default(true) @map("is_active")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  patients Patient[]

  @@index([name])
  @@index([nameKana])
  @@index([isActive])
  @@map("facilities")
}

model Patient {
  id         String    @id @default(uuid())
  name       String
  nameKana   String?   @map("name_kana")
  facilityId String?   @map("facility_id")
  address    String?
  area       String?
  phone      String?
  memo       String?
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  facility  Facility? @relation(fields: [facilityId], references: [id], onDelete: SetNull)
  events    Event[]
  summary   PatientSummary?
  documents PatientDocument[]

  @@index([name])
  @@index([nameKana])
  @@index([facilityId])
  @@index([isActive])
  @@map("patients")
}

model Event {
  id                String      @id @default(uuid())
  type              EventType
  date              DateTime    @db.Date
  time              DateTime?   @db.Time
  patientId         String      @map("patient_id")
  assignedTo        String?     @map("assigned_to")
  memo              String?
  status            EventStatus @default(draft)
  isCompleted       Boolean     @default(false) @map("is_completed")
  isRecurring       Boolean     @default(false) @map("is_recurring")
  recurringInterval Int?        @map("recurring_interval")
  reportDone        Boolean     @default(false) @map("report_done")
  planDone          Boolean     @default(false) @map("plan_done")
  createdBy         String      @map("created_by")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  patient    Patient    @relation(fields: [patientId], references: [id], onDelete: Restrict)
  assignee   User?      @relation("EventAssignedTo", fields: [assignedTo], references: [id], onDelete: SetNull)
  creator    User       @relation("EventCreatedBy", fields: [createdBy], references: [id], onDelete: Restrict)
  reminders  Reminder[]

  @@index([date])
  @@index([patientId])
  @@index([assignedTo])
  @@index([createdBy])
  @@index([status])
  @@index([type, date])
  @@map("events")
}

model ReminderSetting {
  id           String   @id @default(uuid())
  userId       String   @unique @map("user_id")
  visitEnabled Boolean  @default(true) @map("visit_enabled")
  visitTimings Json     @default("[]") @map("visit_timings")
  rxEnabled    Boolean  @default(true) @map("rx_enabled")
  rxTimings    Json     @default("[]") @map("rx_timings")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reminder_settings")
}

model Reminder {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  eventId     String   @map("event_id")
  scheduledAt DateTime @map("scheduled_at")
  isRead      Boolean  @default(false) @map("is_read")
  message     String
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventId])
  @@index([scheduledAt])
  @@index([isRead])
  @@map("reminders")
}

// ============================================
// 患者引き継ぎサマリー
// ============================================

enum ApproachType {
  normal        // 通常対応で問題なし
  careful       // 慎重な対応が必要
  contact_first // 事前連絡をしてから対応
}

model PatientSummary {
  id        String   @id @default(uuid())
  patientId String   @unique @map("patient_id")

  // ① 対応時の最重要注意点（チェックボックス）
  cautionMedicationRefusal      Boolean @default(false) @map("caution_medication_refusal")
  cautionUnderstandingDifficulty Boolean @default(false) @map("caution_understanding_difficulty")
  cautionFamilyPresenceRequired Boolean @default(false) @map("caution_family_presence_required")
  cautionTimeRestriction        Boolean @default(false) @map("caution_time_restriction")
  cautionTroubleRisk            Boolean @default(false) @map("caution_trouble_risk")
  cautionOther                  Boolean @default(false) @map("caution_other")
  cautionOtherText              String? @map("caution_other_text") @db.VarChar(100)

  // ② 絶対に守ること（やってはいけないこと）
  prohibitedActions String? @map("prohibited_actions") @db.VarChar(300)

  // ③ 対応の基本方針
  approachType ApproachType @default(normal) @map("approach_type")
  approachNote String?      @map("approach_note") @db.VarChar(100)

  // ④ 困った時の連絡先
  primaryContactName     String  @map("primary_contact_name") @db.VarChar(50)
  primaryContactRelation String  @map("primary_contact_relation") @db.VarChar(30)
  primaryContactPhone    String  @map("primary_contact_phone") @db.VarChar(20)
  secondaryContactName     String? @map("secondary_contact_name") @db.VarChar(50)
  secondaryContactRelation String? @map("secondary_contact_relation") @db.VarChar(30)
  secondaryContactPhone    String? @map("secondary_contact_phone") @db.VarChar(20)

  // ⑤ 最近の変化・直近トピック
  recentChanges          String   @map("recent_changes") @db.VarChar(300)
  recentChangesUpdatedAt DateTime @map("recent_changes_updated_at")
  recentChangesUpdatedBy String   @map("recent_changes_updated_by")

  // ⑥ 自由補足
  freeNote String? @map("free_note") @db.VarChar(500)

  // メタ情報
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String   @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String   @map("updated_by")

  // Relations
  patient                Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  recentChangesUpdater   User    @relation("SummaryRecentChangesUpdater", fields: [recentChangesUpdatedBy], references: [id])
  creator                User    @relation("SummaryCreator", fields: [createdBy], references: [id])
  updater                User    @relation("SummaryUpdater", fields: [updatedBy], references: [id])
  history                PatientSummaryHistory[]

  @@map("patient_summaries")
}

model PatientSummaryHistory {
  id            String   @id @default(uuid())
  summaryId     String   @map("summary_id")
  snapshot      Json     // 変更時点の全データ
  changedFields Json     @map("changed_fields") // 変更されたフィールド一覧
  changedAt     DateTime @default(now()) @map("changed_at")
  changedBy     String   @map("changed_by")

  // Relations
  summary PatientSummary @relation(fields: [summaryId], references: [id], onDelete: Cascade)
  changer User           @relation(fields: [changedBy], references: [id])

  @@index([summaryId])
  @@index([changedAt])
  @@map("patient_summary_histories")
}

// ============================================
// 患者ドキュメント（ファイル保管）
// ============================================

enum DocumentType {
  facesheet      // フェイスシート
  report         // 他職種からの報告書
  prescription   // 処方箋
  consent        // 同意書
  photo          // 写真（傷の経過など）
  other          // その他
}

model PatientDocument {
  id          String       @id @default(uuid())
  patientId   String       @map("patient_id")
  type        DocumentType @default(other)
  fileName    String       @map("file_name")
  fileSize    Int          @map("file_size")
  mimeType    String       @map("mime_type")
  storagePath String       @map("storage_path")  // Supabase Storage内のパス
  description String?      @db.VarChar(200)
  uploadedBy  String       @map("uploaded_by")
  uploadedAt  DateTime     @default(now()) @map("uploaded_at")

  // Relations
  patient  Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  uploader User    @relation(fields: [uploadedBy], references: [id])

  @@index([patientId])
  @@index([type])
  @@index([uploadedAt])
  @@map("patient_documents")
}
