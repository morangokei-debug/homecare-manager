// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  super_admin  // システム全体管理者（あなた）
  admin        // 会社管理者
  staff        // スタッフ
  viewer       // 閲覧のみ
}

enum DisplayMode {
  grouped
  individual
}

enum EventType {
  visit
  prescription
  both
}

enum EventStatus {
  draft
  confirmed
}

// ============================================
// MODELS
// ============================================

// 会社（テナント）
model Organization {
  id        String   @id @default(uuid())
  name      String   // 会社名
  code      String   @unique // 会社コード（ログイン時の識別用）
  phone     String?  // 電話番号
  address   String?  // 住所
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users      User[]
  patients   Patient[]
  facilities Facility[]

  @@index([code])
  @@index([isActive])
  @@map("organizations")
}

model User {
  id             String   @id @default(uuid())
  email          String   @unique
  passwordHash   String   @map("password_hash")
  name           String
  role           UserRole @default(staff)
  organizationId String?  @map("organization_id") // super_adminはnull可
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  organization     Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdEvents    Event[]    @relation("EventCreatedBy")
  assignedEvents   Event[]    @relation("EventAssignedTo")
  
  // 患者サマリー関連
  summariesAsRecentChangesUpdater PatientSummary[] @relation("SummaryRecentChangesUpdater")
  summariesAsCreator              PatientSummary[] @relation("SummaryCreator")
  summariesAsUpdater              PatientSummary[] @relation("SummaryUpdater")
  summaryHistories                PatientSummaryHistory[]
  
  // 患者ドキュメント関連
  uploadedDocuments PatientDocument[]
  
  // ICSカレンダートークン
  icsToken IcsToken?

  @@index([role])
  @@index([isActive])
  @@index([organizationId])
  @@map("users")
}

// ============================================
// ICSカレンダー購読トークン
// ============================================

model IcsToken {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  token     String   @unique @db.VarChar(64)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@map("ics_tokens")
}

model Facility {
  id             String       @id @default(uuid())
  name           String
  nameKana       String?      @map("name_kana")
  organizationId String       @map("organization_id")
  address        String?
  area           String?
  phone          String?
  contactPerson  String?      @map("contact_person")
  displayMode    DisplayMode  @default(grouped) @map("display_mode")
  memo           String?
  isActive       Boolean      @default(true) @map("is_active")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patients     Patient[]
  events       Event[]

  @@index([name])
  @@index([nameKana])
  @@index([organizationId])
  @@index([isActive])
  @@map("facilities")
}

model Patient {
  id             String    @id @default(uuid())
  name           String
  nameKana       String?   @map("name_kana")
  organizationId String    @map("organization_id")
  facilityId     String?   @map("facility_id")
  address        String?
  area           String?
  phone          String?
  memo           String?
  // 訪問時注意事項（目立つ表示用）
  visitNotes     String?   @map("visit_notes")
  // ケアマネージャー情報
  careManagerName  String? @map("care_manager_name")
  careManagerPhone String? @map("care_manager_phone")
  // キーパーソン情報
  keyPersonName     String? @map("key_person_name")
  keyPersonRelation String? @map("key_person_relation")
  keyPersonPhone    String? @map("key_person_phone")
  
  isActive       Boolean   @default(true) @map("is_active")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  facility     Facility?    @relation(fields: [facilityId], references: [id], onDelete: SetNull)
  events       Event[]
  summary      PatientSummary?
  documents    PatientDocument[]

  @@index([name])
  @@index([nameKana])
  @@index([organizationId])
  @@index([facilityId])
  @@index([isActive])
  @@map("patients")
}

model Event {
  id                String      @id @default(uuid())
  type              EventType
  date              DateTime    @db.Date
  time              DateTime?   @db.Time
  patientId         String?     @map("patient_id")
  facilityId        String?     @map("facility_id")  // 施設全体の訪問用
  assignedTo        String?     @map("assigned_to")
  memo              String?
  status            EventStatus @default(draft)
  isCompleted       Boolean     @default(false) @map("is_completed")
  isRecurring       Boolean     @default(false) @map("is_recurring")
  recurringInterval Int?        @map("recurring_interval")
  reportDone        Boolean     @default(false) @map("report_done")
  planDone          Boolean     @default(false) @map("plan_done")
  createdBy         String      @map("created_by")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  patient    Patient?   @relation(fields: [patientId], references: [id], onDelete: Restrict)
  facility   Facility?  @relation(fields: [facilityId], references: [id], onDelete: Restrict)
  assignee   User?      @relation("EventAssignedTo", fields: [assignedTo], references: [id], onDelete: SetNull)
  creator    User       @relation("EventCreatedBy", fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([date])
  @@index([patientId])
  @@index([facilityId])
  @@index([assignedTo])
  @@index([createdBy])
  @@index([status])
  @@index([type, date])
  @@map("events")
}

// ============================================
// 患者引き継ぎサマリー
// ============================================

enum ApproachType {
  none          // 特にない
  normal        // 通常対応で問題なし
  careful       // 慎重な対応が必要
  contact_first // 事前連絡をしてから対応
}

model PatientSummary {
  id        String   @id @default(uuid())
  patientId String   @unique @map("patient_id")

  // ① 対応時の最重要注意点（チェックボックス）
  cautionMedicationRefusal      Boolean @default(false) @map("caution_medication_refusal")
  cautionUnderstandingDifficulty Boolean @default(false) @map("caution_understanding_difficulty")
  cautionFamilyPresenceRequired Boolean @default(false) @map("caution_family_presence_required")
  cautionTimeRestriction        Boolean @default(false) @map("caution_time_restriction")
  cautionTroubleRisk            Boolean @default(false) @map("caution_trouble_risk")
  cautionOther                  Boolean @default(false) @map("caution_other")
  cautionOtherText              String? @map("caution_other_text") @db.VarChar(100)

  // ② 絶対に守ること（やってはいけないこと）
  prohibitedActions String? @map("prohibited_actions") @db.VarChar(300)

  // ③ 対応の基本方針
  approachType ApproachType @default(normal) @map("approach_type")
  approachNote String?      @map("approach_note") @db.VarChar(100)

  // ④ 困った時の連絡先
  primaryContactName     String  @map("primary_contact_name") @db.VarChar(50)
  primaryContactRelation String  @map("primary_contact_relation") @db.VarChar(30)
  primaryContactPhone    String  @map("primary_contact_phone") @db.VarChar(20)
  secondaryContactName     String? @map("secondary_contact_name") @db.VarChar(50)
  secondaryContactRelation String? @map("secondary_contact_relation") @db.VarChar(30)
  secondaryContactPhone    String? @map("secondary_contact_phone") @db.VarChar(20)

  // ⑤ 最近の変化・直近トピック
  recentChanges          String   @map("recent_changes") @db.VarChar(300)
  recentChangesUpdatedAt DateTime @map("recent_changes_updated_at")
  recentChangesUpdatedBy String   @map("recent_changes_updated_by")

  // ⑥ 自由補足
  freeNote String? @map("free_note") @db.VarChar(500)

  // メタ情報
  createdAt DateTime @default(now()) @map("created_at")
  createdBy String   @map("created_by")
  updatedAt DateTime @updatedAt @map("updated_at")
  updatedBy String   @map("updated_by")

  // Relations
  patient                Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  recentChangesUpdater   User    @relation("SummaryRecentChangesUpdater", fields: [recentChangesUpdatedBy], references: [id])
  creator                User    @relation("SummaryCreator", fields: [createdBy], references: [id])
  updater                User    @relation("SummaryUpdater", fields: [updatedBy], references: [id])
  history                PatientSummaryHistory[]

  @@map("patient_summaries")
}

model PatientSummaryHistory {
  id            String   @id @default(uuid())
  summaryId     String   @map("summary_id")
  snapshot      Json     // 変更時点の全データ
  changedFields Json     @map("changed_fields") // 変更されたフィールド一覧
  changedAt     DateTime @default(now()) @map("changed_at")
  changedBy     String   @map("changed_by")

  // Relations
  summary PatientSummary @relation(fields: [summaryId], references: [id], onDelete: Cascade)
  changer User           @relation(fields: [changedBy], references: [id])

  @@index([summaryId])
  @@index([changedAt])
  @@map("patient_summary_histories")
}

// ============================================
// 患者ドキュメント（ファイル保管）
// ============================================

enum DocumentType {
  facesheet      // フェイスシート
  report         // 他職種からの報告書
  prescription   // 処方箋
  consent        // 同意書
  photo          // 写真（傷の経過など）
  other          // その他
}

model PatientDocument {
  id          String       @id @default(uuid())
  patientId   String       @map("patient_id")
  type        DocumentType @default(other)
  fileName    String       @map("file_name")
  fileSize    Int          @map("file_size")
  mimeType    String       @map("mime_type")
  storagePath String       @map("storage_path")  // Supabase Storage内のパス
  description String?      @db.VarChar(200)
  uploadedBy  String       @map("uploaded_by")
  uploadedAt  DateTime     @default(now()) @map("uploaded_at")

  // Relations
  patient  Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  uploader User    @relation(fields: [uploadedBy], references: [id])

  @@index([patientId])
  @@index([type])
  @@index([uploadedAt])
  @@map("patient_documents")
}
