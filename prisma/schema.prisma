// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum UserRole {
  admin
  staff
  viewer
}

enum DisplayMode {
  grouped
  individual
}

enum EventType {
  visit
  prescription
}

enum EventStatus {
  draft
  confirmed
}

// ============================================
// MODELS
// ============================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  name          String
  role          UserRole @default(staff)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  reminderSetting  ReminderSetting?
  createdEvents    Event[]    @relation("EventCreatedBy")
  assignedEvents   Event[]    @relation("EventAssignedTo")
  reminders        Reminder[]

  @@index([role])
  @@index([isActive])
  @@map("users")
}

model Facility {
  id            String      @id @default(uuid())
  name          String
  nameKana      String?     @map("name_kana")
  address       String?
  area          String?
  phone         String?
  contactPerson String?     @map("contact_person")
  displayMode   DisplayMode @default(grouped) @map("display_mode")
  memo          String?
  isActive      Boolean     @default(true) @map("is_active")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")

  // Relations
  patients Patient[]

  @@index([name])
  @@index([nameKana])
  @@index([isActive])
  @@map("facilities")
}

model Patient {
  id         String    @id @default(uuid())
  name       String
  nameKana   String?   @map("name_kana")
  facilityId String?   @map("facility_id")
  address    String?
  area       String?
  phone      String?
  memo       String?
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  // Relations
  facility Facility? @relation(fields: [facilityId], references: [id], onDelete: SetNull)
  events   Event[]

  @@index([name])
  @@index([nameKana])
  @@index([facilityId])
  @@index([isActive])
  @@map("patients")
}

model Event {
  id                String      @id @default(uuid())
  type              EventType
  date              DateTime    @db.Date
  time              DateTime?   @db.Time
  patientId         String      @map("patient_id")
  assignedTo        String?     @map("assigned_to")
  memo              String?
  status            EventStatus @default(draft)
  isCompleted       Boolean     @default(false) @map("is_completed")
  isRecurring       Boolean     @default(false) @map("is_recurring")
  recurringInterval Int?        @map("recurring_interval")
  createdBy         String      @map("created_by")
  createdAt         DateTime    @default(now()) @map("created_at")
  updatedAt         DateTime    @updatedAt @map("updated_at")

  // Relations
  patient    Patient    @relation(fields: [patientId], references: [id], onDelete: Restrict)
  assignee   User?      @relation("EventAssignedTo", fields: [assignedTo], references: [id], onDelete: SetNull)
  creator    User       @relation("EventCreatedBy", fields: [createdBy], references: [id], onDelete: Restrict)
  reminders  Reminder[]

  @@index([date])
  @@index([patientId])
  @@index([assignedTo])
  @@index([createdBy])
  @@index([status])
  @@index([type, date])
  @@map("events")
}

model ReminderSetting {
  id           String   @id @default(uuid())
  userId       String   @unique @map("user_id")
  visitEnabled Boolean  @default(true) @map("visit_enabled")
  visitTimings Json     @default("[]") @map("visit_timings")
  rxEnabled    Boolean  @default(true) @map("rx_enabled")
  rxTimings    Json     @default("[]") @map("rx_timings")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reminder_settings")
}

model Reminder {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  eventId     String   @map("event_id")
  scheduledAt DateTime @map("scheduled_at")
  isRead      Boolean  @default(false) @map("is_read")
  message     String
  createdAt   DateTime @default(now()) @map("created_at")

  // Relations
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventId])
  @@index([scheduledAt])
  @@index([isRead])
  @@map("reminders")
}
